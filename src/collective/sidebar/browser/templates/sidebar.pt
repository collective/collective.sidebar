<tal:define tal:define="portal_url view/get_portal_url;
                        navigation_root_url view/get_navigation_root_url;
                        toLocalizedTime nocall: context/@@plone/toLocalizedTime;
                        context_url context/absolute_url;
                        cookies view/is_cookies_enabled;
                        collapsible view/is_collapse_enabled;
                        sidebar_sections view/get_sidebar_sections">

  <nav id="portal-navigation"
       tal:define="items view/get_items;
                   token context/@@authenticator/token;
                   token_arg python:'&amp;_authenticator=' + token"
       i18n:domain="collective.sidebar">

    <div class="menu">

      <div class="menu-section" tal:condition="not:view/is_anonymous">
        <div class="menu-profile"
             tal:define="data view/get_user_data;
                         user_info data/user_info;
                         portrait data/portrait;
                         user_url data/user_url">

          <a href="${user_url}">

            <div class="profile-image" style="background-image: url('${portrait}');"></div>

            <div class="profile-info">
              <div class="profile-name" tal:content="python:user_info['fullname'] or user_info['username']"></div>
            </div>

          </a>

        </div>
      </div>

      <!-- Main Menu -->

      <div tal:define="section_state python:sidebar_sections.get('site', 'show')"
           class="menu-section ${python:'collapsed' if section_state == 'hide' else ''}"
           data-section="site"
           data-state="${section_state}"
           tal:condition="view/can_manage_portal">

        <div class="menu-section-title">
          <span i18n:translate="navigation_heading_site">Site</span>

          <span class="section-handle" tal:condition="python:cookies and collapsible and not view.is_anonymous()">
            <i class="section-up glyphicon glyphicon-menu-up"></i>
            <i class="section-down glyphicon glyphicon-menu-down"></i>
          </span>

        </div>

        <tal:item>
          <a href="#" tal:attributes="href python:portal_url + '/plone_control_panel'">
            <span class="menu-item-icon glyphicon glyphicon-cog"></span> <span class="menu-item-title" i18n:translate="navigation_link_settings">Settings</span>
          </a>
        </tal:item>

      </div>

      <div tal:define="links view/get_static_links;
                       section_state python:sidebar_sections.get('links', 'show')"
           class="menu-section ${python:'collapsed' if section_state == 'hide' else ''}"
           id="menu-links"
           data-section="links"
           data-state="${section_state}"
           tal:condition="links">

        <div class="menu-section-title">
          <span i18n:translate="navigation_heading_links">Links</span>

          <span class="section-handle" tal:condition="python:cookies and collapsible and not view.is_anonymous()">
            <i class="section-up glyphicon glyphicon-menu-up"></i>
            <i class="section-down glyphicon glyphicon-menu-down"></i>
          </span>

        </div>

        <tal:actions repeat="link links">
          <a tal:attributes="href link/url;
                             title link/title">
            <span class="menu-item-icon glyphicon ${link/icon}"></span> <span class="menu-item-title" tal:content="link/title"></span>
          </a>
        </tal:actions>

      </div>

      <!-- Navigation Controls -->

      <div tal:define="section_state python:sidebar_sections.get('navigation', 'show')"
           class="menu-section ${python:'collapsed' if section_state == 'hide' else ''}"
           data-section="navigation"
           data-state="${section_state}"
           tal:condition="items">

        <div class="menu-section-title">
          <span i18n:translate="navigation_heading_navigation">Navigation</span>

          <span class="section-handle" tal:condition="python:cookies and collapsible and not view.is_anonymous()">
            <i class="section-up glyphicon glyphicon-menu-up"></i>
            <i class="section-down glyphicon glyphicon-menu-down"></i>
          </span>

        </div>

        <tal:item tal:condition="view/get_back">
          <a href="#" tal:attributes="href view/get_back">
            <span class="menu-item-icon glyphicon glyphicon-menu-left"></span> <span class="menu-item-title" i18n:translate="back">Back</span>
          </a>
        </tal:item>

        <tal:items tal:repeat="item items">
          <a href="#" tal:attributes="title item/title; href item/url;">
            <span class="menu-item-icon glyphicon glyphicon-menu-right"></span> <span class="menu-item-title" tal:content="item/title_cropped"></span>
          </a>
        </tal:items>

      </div>

      <!-- Editing -->

      <div tal:define="section_state python:sidebar_sections.get('edit', 'show')"
           class="menu-section ${python:'collapsed' if section_state == 'hide' else ''}"
           data-section="edit"
           data-state="${section_state}"
           tal:condition="view/can_edit">

        <div class="menu-section-title">
          <span i18n:translate="navigation_heading_edit">Edit</span>

          <span class="section-handle" tal:condition="python:cookies and collapsible and not view.is_anonymous()">
            <i class="section-up glyphicon glyphicon-menu-up"></i>
            <i class="section-down glyphicon glyphicon-menu-down"></i>
          </span>

        </div>

        <a href="#" tal:attributes="href python:context.absolute_url() + '/view'">
          <span class="menu-item-icon glyphicon glyphicon-eye-open"></span> <span class="menu-item-title" i18n:translate="view">View</span>
        </a>

        <a href="#" tal:attributes="href python:context.absolute_url() + '/edit'">
          <span class="menu-item-icon glyphicon glyphicon-edit"></span> <span class="menu-item-title" i18n:translate="edit">Edit</span>
        </a>

        <a href="#" tal:attributes="href python:view.get_folder_contents_url()">
          <span class="menu-item-icon glyphicon glyphicon-folder-open"></span> <span class="menu-item-title" i18n:translate="contents">Contents</span>
        </a>

        <a href="#" tal:attributes="href python:context.absolute_url() + '/@@historyview'">
          <span class="menu-item-icon glyphicon glyphicon-time"></span>
          <span class="menu-item-title" tal:content="python:toLocalizedTime(context.ModificationDate(), long_format=1)">Modified</span>
        </a>

        <a href="#" tal:attributes="href python:context.absolute_url() + '/@@sharing'">
          <span class="menu-item-icon glyphicon glyphicon-user"></span> <span class="menu-item-title" i18n:translate="sharing">Sharing</span>
        </a>

      </div>

      <!-- Workflow -->

      <div tal:define="state view/get_workflow_state;
                  state_title view/get_workflow_state_title;
                  absolute_url context/absolute_url;
                  content_status_modify python:absolute_url + '/content_status_modify';
                  color_state view/has_workflow_state_color;
                  actions view/get_workflow_actions;
                  section_state python:sidebar_sections.get('workflow', 'show')"
           class="menu-section ${python:'collapsed' if section_state == 'hide' else ''}"
           data-section="workflow"
           data-state="${section_state}"
           tal:condition="python:view.can_edit() and view.has_workflow()">

        <div class="menu-section-title">
          <span i18n:translate="navigation_heading_workflow">Workflow</span>

          <span class="section-handle" tal:condition="python:cookies and collapsible and not view.is_anonymous()">
            <i class="section-up glyphicon glyphicon-menu-up"></i>
            <i class="section-down glyphicon glyphicon-menu-down"></i>
          </span>

        </div>

        <a href="#" i18n:domain="plone">
          <span class="menu-item-icon glyphicon glyphicon-record state-${state} ${color_state}"></span> <span class="menu-item-title state-${state} ${color_state}" i18n:translate="">${state_title}</span>
        </a>

        <tal:repeat tal:repeat="action actions">
          <a href="${action/action}" i18n:domain="plone">
            <span class="menu-item-icon glyphicon glyphicon-transfer"></span> <span class="menu-item-title" i18n:translate="">${action/title}</span>
          </a>
        </tal:repeat>

        <a href="${absolute_url}/content_status_history" tal:condition="actions">
          <span class="menu-item-icon glyphicon glyphicon-option-horizontal"></span>
          <span class="menu-item-title" i18n:translate="sidebar_workflow_advanced">Advanced</span>
        </a>

      </div>

      <!-- Actions -->

      <div tal:define="actions view/get_actions;
                       section_state python:sidebar_sections.get('actions', 'show')"
           class="menu-section ${python:'collapsed' if section_state == 'hide' else ''}"
           data-section="actions"
           data-state="${section_state}"
           tal:condition="python:view.is_actions_enabled() and view.can_edit() and view.has_actions()">

        <div class="menu-section-title">
          <span i18n:translate="navigation_heading_actions">Actions</span>

          <span class="section-handle" tal:condition="python:cookies and collapsible and not view.is_anonymous()">
            <i class="section-up glyphicon glyphicon-menu-up"></i>
            <i class="section-down glyphicon glyphicon-menu-down"></i>
          </span>

        </div>

        <tal:repeat tal:repeat="action actions">
          <a tal:condition="action/allowed"
             href="${action/url|nothing}"
             i18n:domain="plone"
             class="${python:'pat-plone-modal' if action.get('modal', None) else ''}"
             data-pat-plone-modal="${action/modal|nothing}">
            <span class="menu-item-icon ${action/icon}"></span> <span class="menu-item-title" i18n:translate="">${action/title}</span>
          </a>
        </tal:repeat>

      </div>

      <!-- Document Management -->

      <div tal:define="items view/get_addable_items;
                       section_state python:sidebar_sections.get('add', 'show')"
           class="menu-section ${python:'collapsed' if section_state == 'hide' else ''}"
           data-section="add"
           data-state="${section_state}"
           tal:condition="items">

        <div class="menu-section-title">
          <span i18n:translate="navigation_heading_add">Add</span>

          <span class="section-handle" tal:condition="python:cookies and collapsible and not view.is_anonymous()">
            <i class="section-up glyphicon glyphicon-menu-up"></i>
            <i class="section-down glyphicon glyphicon-menu-down"></i>
          </span>

        </div>

        <tal:repeat tal:repeat="item items">
          <a href="#" tal:attributes="href item/action">
            <span class="" tal:attributes="class item/icon"></span>
            <span class="menu-item-title" tal:content="item/title"></span>
          </a>
        </tal:repeat>

      </div>

      <!-- Display Management -->

      <div tal:define="section_state python:sidebar_sections.get('display', 'show')"
           class="menu-section ${python:'collapsed' if section_state == 'hide' else ''}"
           data-section="display"
           data-state="${section_state}"
           tal:condition="view/can_edit">

        <div class="menu-section-title">
          <span i18n:translate="navigation_heading_display">Display</span>

          <span class="section-handle" tal:condition="python:cookies and collapsible and not view.is_anonymous()">
            <i class="section-up glyphicon glyphicon-menu-up"></i>
            <i class="section-down glyphicon glyphicon-menu-down"></i>
          </span>

        </div>

        <a href="${view/get_default_view_link}" class="pat-plone-modal">
          <span class="menu-item-icon glyphicon glyphicon-blackboard"></span> <span class="menu-item-title" i18n:translate="select_default_view">Default View</span>
        </a>

        <a href="${view/get_default_page_link}" class="pat-plone-modal">
          <span class="menu-item-icon glyphicon glyphicon-pushpin"></span> <span class="menu-item-title" i18n:translate="select_default_page">Default Page</span>
        </a>

      </div>

      <!-- Search -->

      <div tal:define="section_state python:sidebar_sections.get('search', 'show')"
           class="menu-section ${python:'collapsed' if section_state == 'hide' else ''}"
           data-section="search"
           data-state="${section_state}">

        <div class="menu-section-title">
          <span i18n:translate="navigation_heading_search">Search</span>

          <span class="section-handle" tal:condition="python:cookies and collapsible and not view.is_anonymous()">
            <i class="section-up glyphicon glyphicon-menu-up"></i>
            <i class="section-down glyphicon glyphicon-menu-down"></i>
          </span>

        </div>

        <form action="" id="menu-search" method="post">
          <input class="menu-search-input" type="text" value="">
        </form>

      </div>

    </div>

    <script type="text/javascript" tal:define="searchpath python:view.get_search_path(query=True)">
      $('#menu-search').submit(function() {
        var search_val = $('.menu-search-input').val();
        var search_construct = '${searchpath}' + search_val;
        $('#menu-search').attr('action', search_construct);
      });
    </script>

    <tal:condition tal:condition="python:cookies and collapsible and not view.is_anonymous()">
      <script type="text/javascript">

        var sections = {};

        $('.menu-section').each(function() {
          var name = $(this).attr('data-section');
          var state = $(this).attr('data-state');
          sections[name] = state;
        });

        $(document).ready(function() {
          if (typeof $.cookie('sidebar-sections') === 'undefined'){
            $.cookie('sidebar-sections', JSON.stringify(sections));
          } else {
            $('.menu-section-title').click(function() {
              var parent = $(this).parent();
              if (parent.attr('data-state') == 'show') {
                parent.attr('data-state', 'hide');
              } else {
                parent.attr('data-state', 'show');
              }
              parent.toggleClass('collapsed');
              var parent_name = parent.attr('data-section');
              var parent_state = parent.attr('data-state');
              var set_sections = $.parseJSON($.cookie('sidebar-sections'));
              set_sections[parent_name] = parent_state;
              $.cookie('sidebar-sections', JSON.stringify(set_sections));
            });
          }
        })

      </script>
    </tal:condition>

  </nav>

</tal:define>
